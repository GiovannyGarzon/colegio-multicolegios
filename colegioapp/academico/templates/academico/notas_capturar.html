{% extends "colegioapp/base.html" %}
{% load extras %}
{% block title %}Captura de Notas | CEI GIN GABY{% endblock %}

{% block content %}
<main>
  <h2>Captura de Notas</h2>
  <p style="margin-top:-6px;">
    <strong>Año:</strong> {{ oferta.anio.nombre }} &nbsp;•&nbsp;
    <strong>Curso:</strong> {{ oferta.curso.grado }} - {{ oferta.curso.nombre }} &nbsp;•&nbsp;
    <strong>Asignatura:</strong> {{ oferta.asignatura.nombre }} &nbsp;•&nbsp;
    <strong>Periodo:</strong> {{ periodo.nombre }}
  </p>

  <div style="background:#e3f2fd;padding:10px 14px;border-radius:8px;margin:10px auto 18px;max-width:900px;color:#0d47a1;">
    <strong>Nota:</strong> Las calificaciones de cada logro se calculan automáticamente
    a partir de las <strong>actividades</strong> asociadas (escala 0.00–5.00).
  </div>

  {% if not logros %}
    <div style="max-width:980px;margin:0 auto;background:#fff;padding:16px;border-radius:12px;border:1px dashed #b0bec5;">
      <p style="margin:0;">No hay logros configurados para esta oferta en este periodo. Primero crea logros.</p>
      <a href="{% url 'academico:logros' %}"
         style="display:inline-block;margin-top:10px;padding:8px 12px;background:#004d40;color:#fff;border-radius:8px;text-decoration:none;">
        Gestionar Logros
      </a>
    </div>
  {% else %}

  <div style="min-width:880px;background:#fff;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.06);overflow:auto;">
    <table style="width:100%;border-collapse:collapse;">
      <thead style="background:#e0f2f1;">
        <tr>
          <th style="padding:12px;text-align:left;white-space:nowrap;">Estudiante</th>

          {% for l in logros %}
          <th style="padding:12px;text-align:center;min-width:170px;">
            <div>
              <strong>{{ l.titulo }}</strong><br>
              <small>Peso logro: {{ l.peso }}%</small>
            </div>

            {% with acts=actividades_por_logro|get_item:l.id %}
              {% if not acts %}
                <div style="margin-top:6px;font-size:11px;color:#c62828;">
                  Sin actividades configuradas
                </div>
              {% else %}
                <div style="margin-top:6px;">
                  <a href="{% url 'academico:actividades' l.id %}"
                     style="display:inline-block;background:#546e7a;color:#fff;padding:4px 8px;font-size:12px;border-radius:6px;text-decoration:none;">
                    Gestionar actividades ({{ acts|length }})
                  </a>
                </div>
              {% endif %}
            {% endwith %}
          </th>
          {% endfor %}
        </tr>
      </thead>

      <tbody>
        {% for e in estudiantes %}
        <tr style="border-top:1px solid #eceff1;">
          <td style="padding:10px 12px;white-space:nowrap;">
            {{ e.apellidos }} {{ e.nombres }}
          </td>

          {% for l in logros %}
            <td style="padding:8px 10px;text-align:center;font-size:13px;">
              {% with acts=actividades_por_logro|get_item:l.id %}
                {% if not acts %}
                  <span style="color:#b0bec5;">Sin actividades</span>
                {% else %}
                  {# buscamos notas_por_estudiante_logro[e.id][l.id] #}
                  {% with notas_est=notas_por_estudiante_logro|get_item:e.id %}
                    {% if notas_est %}
                      {% with nota=notas_est|get_item:l.id %}
                        {% if nota %}
                          <span style="font-weight:bold;">{{ nota }}</span>
                        {% else %}
                          <span style="color:#ff8f00;">Sin calificaciones de actividades</span>
                        {% endif %}
                      {% endwith %}
                    {% else %}
                      <span style="color:#ff8f00;">Sin calificaciones de actividades</span>
                    {% endif %}
                  {% endwith %}
                {% endif %}
              {% endwith %}
            </td>
          {% endfor %}
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:14px;">
    <a href="{% url 'academico:notas_selector' %}"
       style="padding:10px 16px;background:#9e9e9e;color:#fff;border-radius:8px;text-decoration:none;">
      ← Cambiar selección
    </a>
  </div>

  {% endif %}
</main>
{% endblock %}