{% extends "colegioapp/base.html" %}
{% load extras %}
{% block title %}Captura de Notas | CEI GIN GABY{% endblock %}
{% block content %}
<main>
  <h2>Captura de Notas</h2>
  <p style="margin-top:-6px;">
    <strong>A√±o:</strong> {{ oferta.anio.nombre }} &nbsp;‚Ä¢&nbsp;
    <strong>Curso:</strong> {{ oferta.curso.grado }} - {{ oferta.curso.nombre }} &nbsp;‚Ä¢&nbsp;
    <strong>Asignatura:</strong> {{ oferta.asignatura.nombre }} &nbsp;‚Ä¢&nbsp;
    <strong>Periodo:</strong> {{ periodo.nombre }}
  </p>

  <!-- üîπ Leyenda sobre escala de notas -->
  <div style="background:#e3f2fd;padding:10px 14px;border-radius:8px;margin:10px auto 18px;max-width:900px;color:#0d47a1;">
    <strong>Nota:</strong> Las calificaciones deben ingresarse en una escala de <strong>0.00 a 5.00</strong>.
    <br>Ejemplo: 3.50 (Aprobado), 4.50 (Sobresaliente), 2.50 (En proceso).
  </div>
  <!-- üîπ Fin leyenda -->

  {# üî∏ Aviso cuando ya existen notas guardadas para esta oferta + periodo #}
  {% if ya_hay_notas %}
    <div style="background:#fff3cd;padding:10px 14px;border-radius:8px;
                margin:0 auto 18px;max-width:900px;color:#8a6d3b;border:1px solid #ffeeba;">
      <strong>Atenci√≥n:</strong> Ya existen notas registradas para esta asignatura y periodo.
      Si modificas los valores y guardas, estar√°s <strong>editando</strong> las notas existentes.
    </div>
  {% endif %}

  {% if not logros %}
    <div style="max-width:980px;margin:0 auto;background:#fff;padding:16px;border-radius:12px;border:1px dashed #b0bec5;">
      <p style="margin:0;">No hay logros configurados para esta oferta en este periodo. Primero crea logros.</p>
      <a href="{% url 'academico:logros' %}"
         style="display:inline-block;margin-top:10px;padding:8px 12px;background:#004d40;color:#fff;border-radius:8px;text-decoration:none;">
        Gestionar Logros
      </a>
    </div>
  {% else %}
  <form method="post" style="max-width:100%;overflow:auto;"
        {% if ya_hay_notas %}
          onsubmit="return confirm('Ya existen notas para esta asignatura y periodo. ¬øDeseas editar las calificaciones guardadas?');"
        {% endif %}>
    {% csrf_token %}
    <div style="min-width:880px;background:#fff;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.06);overflow:auto;">
      <table style="width:100%;border-collapse:collapse;">
        <thead style="background:#e0f2f1;">
          <tr>
            <th style="padding:12px;text-align:left;white-space:nowrap;">Estudiante</th>
            {% for l in logros %}
              <th style="padding:12px;text-align:center;min-width:120px;">
                {{ l.titulo }}<br><small>Peso: {{ l.peso }}%</small>
              </th>
            {% endfor %}
          </tr>
        </thead>
        <tbody>
          {% for e in estudiantes %}
          <tr style="border-top:1px solid #eceff1;">
            <td style="padding:10px 12px;white-space:nowrap;">{{ e.apellidos }} {{ e.nombres }}</td>
            {% for l in logros %}
              {% with key=e.id|stringformat:'s'|add:'_'|add:l.id|stringformat:'s' %}
              <td style="padding:8px 10px;text-align:center;">
                <input
                  type="number" step="0.01" min="0" max="5"
                  name="nota_{{ e.id }}_{{ l.id }}"
                  value="{{ existentes_str|get_item:key|default_if_none:'' }}"
                  style="width:110px;padding:8px;border:1px solid #cfd8dc;border-radius:8px;text-align:center;">
              </td>
              {% endwith %}
            {% endfor %}
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:14px;">
      <a href="{% url 'academico:notas_selector' %}"
         style="padding:10px 16px;background:#9e9e9e;color:#fff;border-radius:8px;text-decoration:none;">
        ‚Üê Cambiar selecci√≥n
      </a>
      <button type="submit"
              style="padding:10px 16px;background:#00796B;color:#fff;border:none;border-radius:8px;cursor:pointer;">
        Guardar notas
      </button>
    </div>
  </form>
  {% endif %}
</main>
{% endblock %}