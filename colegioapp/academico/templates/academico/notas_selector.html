{% extends "colegioapp/base.html" %}
{% block title %}Captura de Notas • Selector | CEI GIN GABY{% endblock %}
{% block content %}
<main>
  <h2>Captura de Notas — Selección</h2>
  {% if docente and not user.is_staff and not user.is_superuser %}
    <p style="margin-top:-4px;color:#607d8b;">
      Solo se muestran los cursos y asignaturas que tiene asignados como docente.
    </p>
  {% else %}
    <p>Elige el año, curso, la oferta (asignatura en ese curso y año) y el periodo.</p>
  {% endif %}

  {# FORMULARIO 1: solo para filtrar (se queda en notas_selector) #}
  <form method="get"
        action="{% url 'academico:notas_selector' %}"
        style="max-width:900px;margin:0 auto;background:#fff;padding:20px;border-radius:12px;box-shadow:0 4px 10px rgba(0,0,0,0.08);display:grid;grid-template-columns:1fr 1fr;gap:14px;">

    {# AÑO #}
    <div>
      <label style="font-weight:bold;">Año lectivo</label>
      <select name="anio"
              required
              onchange="this.form.submit()"
              style="width:100%;padding:10px;border:1px solid #cfd8dc;border-radius:8px;">
        <option value="">Seleccione…</option>
        {% for a in anios %}
          <option value="{{ a.id }}" {% if anio_selected == a.id|stringformat:'s' %}selected{% endif %}>
            {{ a.nombre }} {% if a.activo %} (activo){% endif %}
          </option>
        {% endfor %}
      </select>
    </div>

    {# CURSO: deshabilitado mientras no haya año #}
    <div>
      <label style="font-weight:bold;">Curso</label>
      <select name="curso"
              required
              {% if not anio_selected %}disabled{% endif %}
              onchange="this.form.submit()"
              style="width:100%;padding:10px;border:1px solid #cfd8dc;border-radius:8px;">
        <option value="">Seleccione…</option>
        {% for c in cursos %}
          <option value="{{ c.id }}" {% if curso_selected == c.id|stringformat:'s' %}selected{% endif %}>
            {{ c.grado }} - {{ c.nombre }}
          </option>
        {% endfor %}
      </select>
    </div>

    {# OFERTA: depende de año + curso, deshabilitada hasta tener los dos #}
    <div>
      <label style="font-weight:bold;">Oferta (Año | Curso | Asignatura)</label>
      <select name="oferta"
              required
              {% if not anio_selected or not curso_selected %}disabled{% endif %}
              onchange="this.form.submit()"
              style="width:100%;padding:10px;border:1px solid #cfd8dc;border-radius:8px;">
        <option value="">Seleccione…</option>
        {% for o in ofertas %}
          <option value="{{ o.id }}" {% if oferta_selected == o.id|stringformat:'s' %}selected{% endif %}>
            {{ o.anio.nombre }} | {{ o.curso.grado }}-{{ o.curso.nombre }} | {{ o.asignatura.nombre }}
          </option>
        {% endfor %}
      </select>
    </div>

    {# PERIODO #}
    <div>
      <label style="font-weight:bold;">Periodo</label>
      <select name="periodo"
              required
              {% if not anio_selected %}disabled{% endif %}
              onchange="this.form.submit()"
              style="width:100%;padding:10px;border:1px solid #cfd8dc;border-radius:8px;">
        <option value="">Seleccione…</option>
        {% for p in periodos %}
          <option value="{{ p.id }}" {% if periodo_selected == p.id|stringformat:'s' %}selected{% endif %}>
            {{ p.anio.nombre }} - {{ p.nombre }}
          </option>
        {% endfor %}
      </select>
    </div>

    <div style="grid-column:1/-1;display:flex;gap:10px;justify-content:flex-end;margin-top:4px;">
      <a href="{% url 'academico:hub' %}"
         style="padding:10px 16px;background:#9e9e9e;color:#fff;border-radius:8px;text-decoration:none;">
        Ir a gestión académica avanzada
      </a>
    </div>
  </form>

  {# FORMULARIO 2: solo aparece cuando ya hay selección completa, y este sí va a notas_capturar #}
  {% if anio_selected and curso_selected and oferta_selected and periodo_selected %}
    <form method="get"
          action="{% url 'academico:notas_capturar' %}"
          style="max-width:900px;margin:10px auto 0;display:flex;justify-content:flex-end;gap:10px;">
      <input type="hidden" name="anio" value="{{ anio_selected }}">
      <input type="hidden" name="curso" value="{{ curso_selected }}">
      <input type="hidden" name="oferta" value="{{ oferta_selected }}">
      <input type="hidden" name="periodo" value="{{ periodo_selected }}">

      <button type="submit"
              style="padding:10px 16px;background:#00796B;color:#fff;border:none;border-radius:8px;cursor:pointer;">
        Continuar a capturar
      </button>
    </form>
  {% endif %}
</main>
{% endblock %}