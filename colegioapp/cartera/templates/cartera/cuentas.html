{% extends "colegioapp/base.html" %}
{% load static %}
{% load humanize %}

{% block title %}Cuentas por Cobrar | Centro Educativo Infantil GIN GABY{% endblock %}

{% block content %}
<main>
  <h2>Cuentas por Cobrar</h2>

  <!-- Filtros -->
  <form method="get"
        style="max-width:1100px;margin:0 auto 18px;display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
    <input type="text" name="q" value="{{ q }}"
           placeholder="Buscar por estudiante, identificación o concepto"
           style="flex:1; padding:10px 12px; border:1px solid #cfd8dc; border-radius:8px;" />

    <select name="anio"
            style="padding:10px 12px; border:1px solid #cfd8dc; border-radius:8px;">
      <option value="">Todos los años</option>
      {% for a in anios %}
        <option value="{{ a.id }}" {% if anio_selected == a.id|stringformat:'s' %}selected{% endif %}>
          {{ a.nombre }}{% if a.activo %} (vigente){% endif %}
        </option>
      {% endfor %}
    </select>

    <select name="concepto"
            style="padding:10px 12px; border:1px solid #cfd8dc; border-radius:8px;">
      <option value="">Todos los conceptos</option>
      {% for c in conceptos %}
        <option value="{{ c.id }}" {% if concepto_selected == c.id|stringformat:'s' %}selected{% endif %}>
          {{ c.nombre }} - {{ c.anio.nombre }}
        </option>
      {% endfor %}
    </select>

    <select name="estado"
            style="padding:10px 12px; border:1px solid #cfd8dc; border-radius:8px;">
      <option value="">Estado: Todos</option>
      <option value="pendiente" {% if estado == 'pendiente' %}selected{% endif %}>Pendientes</option>
      <option value="vencida" {% if estado == 'vencida' %}selected{% endif %}>Vencidas</option>
      <option value="pagada" {% if estado == 'pagada' %}selected{% endif %}>Pagadas</option>
    </select>

    <button type="submit"
            style="padding:10px 16px; background:#00796B; color:white;
                   border:none; border-radius:8px; cursor:pointer;">
      Filtrar
    </button>
    <a href="{% url 'cartera:cuentas' %}"
       style="padding:10px 16px; background:#90a4ae; color:white; border-radius:8px;
              text-decoration:none;">Limpiar</a>
    <a href="{% url 'cartera:cuenta_create' %}"
       style="padding:10px 14px;background:#00796B;color:#fff;border-radius:8px;text-decoration:none;">
      + Nueva cuenta por cobrar
    </a>
    <a href="{% url 'cartera:cargos_mensuales_selector' %}"
       style="padding:10px 14px;background:#00695c;color:#fff;border-radius:8px;text-decoration:none;">
      ⚙ Generar cargos por curso/mes
    </a>
  </form>

  <!-- Tabla -->
  <div style="max-width:1100px;margin:0 auto;">
    <div style="overflow-x:auto; background:white; border-radius:12px;
                box-shadow:0 4px 12px rgba(0,0,0,0.06);">
      <table style="width:100%; border-collapse:collapse;">
        <thead style="background:#e0f2f1;">
          <tr>
            <th style="text-align:left; padding:12px;">Estudiante</th>
            <th style="text-align:left; padding:12px;">Concepto</th>
            <th style="text-align:left; padding:12px;">Año</th>
            <th style="text-align:left; padding:12px;">Generación</th>
            <th style="text-align:left; padding:12px;">Vencimiento</th>
            <th style="text-align:right; padding:12px;">Valor</th>
            <th style="text-align:right; padding:12px;">Saldo</th>
            <th style="text-align:center; padding:12px;">Estado</th>
            <th style="text-align:center; padding:12px;">Acciones</th>
          </tr>
        </thead>
        <tbody>
          {% if page_obj.object_list %}
            {% for c in page_obj.object_list %}
              <tr style="border-top:1px solid #eceff1;
                         {% if not c.pagada and c.saldo_pendiente > 0 and c.fecha_vencimiento and c.fecha_vencimiento < hoy %}
                           background:#fff8e1;
                         {% endif %}">
                <td style="padding:10px 12px;">
                  {{ c.estudiante.apellidos }} {{ c.estudiante.nombres }}
                  <small style="color:#78909c;">({{ c.estudiante.identificacion }})</small>
                </td>
                <td style="padding:10px 12px;">{{ c.concepto.nombre }}</td>
                <td style="padding:10px 12px;">{{ c.concepto.anio.nombre }}</td>
                <td style="padding:10px 12px;">{{ c.fecha_generacion|date:"Y-m-d" }}</td>
                <td style="padding:10px 12px;">{{ c.fecha_vencimiento|date:"Y-m-d"|default:"—" }}</td>
                <td style="padding:10px 12px; text-align:right;">
                  ${{ c.valor_total|floatformat:0|intcomma }}
                </td>
                <td style="padding:10px 12px; text-align:right;">
                  ${{ c.saldo_pendiente|floatformat:0|intcomma }}
                </td>
                <td style="padding:10px 12px; text-align:center;">
                  {% if c.pagada %}
                    <span style="background:#e8f5e9;color:#2e7d32;padding:4px 8px;border-radius:12px;">
                      Pagada
                    </span>
                  {% elif not c.pagada and c.saldo_pendiente > 0 and c.fecha_vencimiento and c.fecha_vencimiento < hoy %}
                    <span style="background:#ffebee;color:#c62828;padding:4px 8px;border-radius:12px;">
                      Vencida
                    </span>
                  {% else %}
                    <span style="background:#fff3e0;color:#ef6c00;padding:4px 8px;border-radius:12px;">
                      Pendiente
                    </span>
                  {% endif %}
                </td>
                <td style="padding:10px 12px; text-align:center; white-space:nowrap;">
                  <a href="{% url 'cartera:cuenta_update' c.id %}"
                     style="padding:6px 10px;background:#0277bd;color:#fff;border-radius:6px;text-decoration:none;margin-right:6px;">
                    Editar
                  </a>
                  <a href="{% url 'cartera:cuenta_delete' c.id %}"
                     style="padding:6px 10px;background:#c62828;color:#fff;border-radius:6px;text-decoration:none;"
                     onclick="return confirm('¿Deseas eliminar esta cuenta por cobrar?');">
                    Eliminar
                  </a>
                </td>
              </tr>
            {% endfor %}
          {% else %}
            <tr>
              <td colspan="8"
                  style="padding:14px; text-align:center; color:#607d8b;">
                No se encontraron cuentas.
              </td>
            </tr>
          {% endif %}
        </tbody>
      </table>
    </div>

    <!-- Paginación -->
    {% if page_obj.paginator.num_pages > 1 %}
      <div style="display:flex; justify-content:center; gap:6px; margin:18px 0;">
        {% if page_obj.has_previous %}
          <a href="?page=1{% if querystring %}&{{ querystring }}{% endif %}"
             style="padding:8px 10px; border:1px solid #cfd8dc; border-radius:8px; text-decoration:none;">
            « Primero
          </a>
          <a href="?page={{ page_obj.previous_page_number }}{% if querystring %}&{{ querystring }}{% endif %}"
             style="padding:8px 10px; border:1px solid #cfd8dc; border-radius:8px; text-decoration:none;">
            ‹ Anterior
          </a>
        {% endif %}

        <span style="padding:8px 10px; border:1px solid #cfd8dc; border-radius:8px; background:#f5f5f5;">
          Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}
        </span>

        {% if page_obj.has_next %}
          <a href="?page={{ page_obj.next_page_number }}{% if querystring %}&{{ querystring }}{% endif %}"
             style="padding:8px 10px; border:1px solid #cfd8dc; border-radius:8px; text-decoration:none;">
            Siguiente ›
          </a>
          <a href="?page={{ page_obj.paginator.num_pages }}{% if querystring %}&{{ querystring }}{% endif %}"
             style="padding:8px 10px; border:1px solid #cfd8dc; border-radius:8px; text-decoration:none;">
            Última »
          </a>
        {% endif %}
      </div>
    {% endif %}

    <!-- Botón volver -->
    <div style="text-align:center; margin-top:20px;">
      <a href="{% url 'cartera:home' %}"
         style="padding:10px 18px; background:#004d40; color:white;
                text-decoration:none; border-radius:8px;">
        ⬅ Volver al módulo Cartera
      </a>
    </div>
  </div>
</main>
{% endblock content %}