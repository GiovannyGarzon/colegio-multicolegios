{% extends "colegioapp/base.html" %}
{% load static %}

{% block title %}Promocionar matrículas{% endblock %}

{% block content %}
<main>
  <h2>Promoción masiva de matrículas</h2>

  <!-- Mensajes -->
  {% if messages %}
    {% for message in messages %}
      <div style="padding:10px 14px; border-radius:8px; margin:10px 0;
                  background:{% if message.tags == 'success' %}#e8f5e9
                             {% elif message.tags == 'error' %}#ffebee
                             {% else %}#eceff1{% endif %};
                  color:#263238;">
        {{ message }}
      </div>
    {% endfor %}
  {% endif %}

  <!-- 1. Filtros de origen (GET) -->
  <form method="get" style="margin:20px 0; padding:16px; border-radius:8px; background:#fff;">
    <h3 style="margin-top:0;">1. Selecciona año y curso de ORIGEN</h3>

    <div style="display:flex; gap:20px;">
      <div style="flex:1;">
        <label style="font-weight:600;">Año origen</label>
        <select name="anio_origen" style="width:100%; padding:8px; border-radius:6px;">
          <option value="">---------</option>
          {% for a in anios %}
            <option value="{{ a.id }}" {% if a.id|stringformat:"s" == anio_origen_id %}selected{% endif %}>
              {{ a.nombre }}
            </option>
          {% endfor %}
        </select>
      </div>

      <div style="flex:1;">
        <label style="font-weight:600;">Curso origen</label>
        <select name="curso_origen" style="width:100%; padding:8px; border-radius:6px;">
          <option value="">---------</option>
          {% for c in cursos %}
            <option value="{{ c.id }}" {% if c.id|stringformat:"s" == curso_origen_id %}selected{% endif %}>
              {{ c }}
            </option>
          {% endfor %}
        </select>
      </div>
    </div>

    <button type="submit"
            style="margin-top:14px; padding:8px 14px; border:none;
                   border-radius:6px; background:#00796B; color:white; cursor:pointer;">
      Cargar estudiantes
    </button>
  </form>

  {% if matriculas_origen %}
  <!-- 2. Selección de destino + checkboxes (POST) -->
  <form method="post" style="margin-top:20px;">
    {% csrf_token %}
    <input type="hidden" name="anio_origen" value="{{ anio_origen_id }}">
    <input type="hidden" name="curso_origen" value="{{ curso_origen_id }}">

    <div style="padding:16px; border-radius:8px; background:#fff; margin-bottom:16px;">
      <h3 style="margin-top:0;">2. Selecciona año y curso DESTINO</h3>

      <div style="display:flex; gap:20px;">
        <div style="flex:1;">
          <label style="font-weight:600;">Año destino</label>
          <select name="anio_destino" style="width:100%; padding:8px; border-radius:6px;">
            <option value="">---------</option>
            {% for a in anios %}
              <option value="{{ a.id }}">{{ a.nombre }}</option>
            {% endfor %}
          </select>
        </div>

        <div style="flex:1;">
          <label style="font-weight:600;">Curso destino</label>
          <select name="curso_destino" style="width:100%; padding:8px; border-radius:6px;">
            <option value="">---------</option>
            {% for c in cursos %}
              <option value="{{ c.id }}">{{ c }}</option>
            {% endfor %}
          </select>
        </div>
      </div>
    </div>

    <div style="padding:16px; border-radius:8px; background:#fff;">
      <h3 style="margin-top:0;">3. Marca los estudiantes a promocionar</h3>

      <table style="width:100%; border-collapse:collapse; margin-top:10px;">
        <thead>
          <tr style="background:#e0f2f1;">
            <th style="padding:6px; border:1px solid #ccc;">
              <input type="checkbox" id="check-all"
                     onclick="document.querySelectorAll('.chk-estudiante').forEach(c => c.checked = this.checked);">
            </th>
            <th style="padding:6px; border:1px solid #ccc;">Estudiante</th>
            <th style="padding:6px; border:1px solid #ccc;">Identificación</th>
          </tr>
        </thead>
        <tbody>
        {% for m in matriculas_origen %}
          <tr>
            <td style="text-align:center; border:1px solid #eee; padding:4px;">
              <input type="checkbox"
                     class="chk-estudiante"
                     name="estudiantes"
                     value="{{ m.estudiante.id }}">
            </td>
            <td style="border:1px solid #eee; padding:4px;">
              {{ m.estudiante.apellidos }} {{ m.estudiante.nombres }}
            </td>
            <td style="border:1px solid #eee; padding:4px;">
              {{ m.estudiante.identificacion }}
            </td>
          </tr>
        {% endfor %}
        </tbody>
      </table>

      <div style="margin-top:16px; text-align:right;">
        <button type="submit"
                style="padding:10px 18px; border:none; border-radius:8px;
                       background:#004d40; color:white; cursor:pointer;">
          Crear matrículas en año destino
        </button>
      </div>
    </div>
  </form>
  {% elif anio_origen_id and curso_origen_id %}
    <p>No se encontraron estudiantes matriculados en ese año y curso.</p>
  {% endif %}

</main>
{% endblock %}